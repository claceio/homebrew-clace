# typed: false
# frozen_string_literal: true

# This file was generated by GoReleaser. DO NOT EDIT.
class Openrun < Formula
  desc ""
  homepage "https://openrun.dev"
  version "0.15.20"

  depends_on "mkcert"

  on_macos do
    if Hardware::CPU.intel?
      url "https://github.com/openrundev/openrun/releases/download/v0.15.20/openrun-v0.15.20-darwin-amd64.tar.gz"
      sha256 "8ac208ea5b1738732b93d3f1c67e91a35af62e17216ef2f59b49938af2ad78e9"

      def install
        bin.install "openrun"
      end
    end
    if Hardware::CPU.arm?
      url "https://github.com/openrundev/openrun/releases/download/v0.15.20/openrun-v0.15.20-darwin-arm64.tar.gz"
      sha256 "fd48b39734c4e64e7fe2d26ab0050c4a2418f56e92651d83026a1094c6cbdfce"

      def install
        bin.install "openrun"
      end
    end
  end

  on_linux do
    if Hardware::CPU.intel? && Hardware::CPU.is_64_bit?
      url "https://github.com/openrundev/openrun/releases/download/v0.15.20/openrun-v0.15.20-linux-amd64.tar.gz"
      sha256 "8ba5bbcfb82c88fdc1311f508c88a00a3116f0b53cce084332a7a84760cc025b"
      def install
        bin.install "openrun"
      end
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/openrundev/openrun/releases/download/v0.15.20/openrun-v0.15.20-linux-arm64.tar.gz"
      sha256 "1d72bde922f8a6c49cfcfa7c3aacb1829a87a1a697e76c1343843f546805ecc2"
      def install
        bin.install "openrun"
      end
    end
  end

  def post_install
    unless File.exist?("#{etc}/openrun.toml")
      pid = spawn("#{opt_bin}/openrun password", out: "#{etc}/openrun.toml")
      puts "********** Initializing \"admin\" user **********"
      Process.wait(pid)
      puts "************* Save this password ****************"

      mkcert_path = `which mkcert`.chomp
      unless mkcert_path.empty?
        system("mkdir -p #{HOMEBREW_PREFIX}/var/openrun/config/certificates")
        system("#{mkcert_path} -install")
        system("#{mkcert_path} -cert-file #{HOMEBREW_PREFIX}/var/openrun/config/certificates/default.crt -key-file #{HOMEBREW_PREFIX}/var/openrun/config/certificates/default.key localhost 127.0.0.1 \"*.localhost\"")
        puts "Created localhost TLS certificates"
      end
    end
  end

  service do
    run [ opt_bin/"openrun", "server", "start" ]
    keep_alive true
    working_dir HOMEBREW_PREFIX
    log_path var/"log/openrun.log"
    error_log_path var/"log/openrun.log"
  end
end
